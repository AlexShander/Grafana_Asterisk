[globals]
RECORDING=1;
monitordir=/var/spool/asterisk/monitor;
mytrunk=999666

#include extensions_ident_handlers.conf

[from-trunk]
exten => _${mytrunk},1,Verbose(2, We resive new call)
  same => n,Set(SHARED(STARTANSWERTIME,${CHANNEL})=0)
  same => n,Set(CDR(did)=+7${EXTEN:-10})
  same => n,Set(__DID=${CDR(did)})
  same => n,Set(CDR(realsrc)=+7${CALLERID(num):-10})
  same => n,Set(CDR(realdst)=${EXTEN})
  same => n,Set(CDR(edest)=+7${EXTEN:-10})
  same => n,Ringing()
  same => n,Wait(2)
  same => n,Answer()
  same => n,Playback(hello)
  same => n,Set(CDR(start)=${CDR(start)})
  same => n,Gosub(record-file,s,1(${EXTEN}))
  same => n,Set(__TRANSFER_CONTEXT=from-internal)
  same => n,Set(__identifier=${UNIQUEID})
  same => n,Set(CHANNEL(hangup_handler_push)=end-in-call,s,1(${identifier}))
  same => n,Gosub(start-in-call,s,1(${identifier},${CDR(realsrc)},${CDR(did)}))
  same => n,QueueLog(6001,${UNIQUEID},NONE,DID,${DID}|${CDR(filename)})
  same => n,Queue(6001,tkr)
exten => h,1,Noop(END CALLS - ${ANSWEREDTIME} seconds )
  same => n,Noop("extended CDR - time ${TIMESTAMP}")
  same => n,Set(CDR(billseccustom)=${CDR(billsec)})
  same => n,Set(CDR(hangupcause)=16)
  same => n,Set(CDR(peerip)=${PJSIP_CONTACT(${CONTACT},via_addr)})
  same => n,Set(CDR(recvip)=${PJSIP_CONTACT(${CONTACT},uri)})
  same => n,Set(CDR(fromuri)=${CHANNEL(pjsip,remote_addr)})
  same => n,Set(CDR(remoteip)=${PJSIP_CONTACT(${CONTACT},uri)})
  same => n,Set(CDR(uri)=${CHANNEL(pjsip,request_uri)})
  same => n,Set(USER_AGENT=${PJSIP_CONTACT(${CONTACT},user_agent)})
  same => n,Set(CDR(useragent)=${USER_AGENT})
  same => n,Set(CDR(codec1)=${CHANNEL(audioreadformat)})
  same => n,Set(CDR(codec2)=${CHANNEL(audiowriteformat)})
  same => n,Set(CDR(llp)=${CHANNEL(rtcp,local_normdevrxploss)})
  same => n,Set(CDR(rlp)=${CHANNEL(rtcp,remote_normdevrxploss)})
  same => n,Set(CDR(ljitt)=${CHANNEL(rtcp,local_normdevjitter)})
  same => n,Set(CDR(rjitt)=${CHANNEL(rtcp,remote_normdevjitter)})
  same => n,Set(CDR(durationcustom)=${CDR(duration)})
  same => n,Return()


[from-internal]
exten => _10[1345678],1,Verbose(2, We resive new call from Operator ${CALLERID(num)})
  same => n,Set(CONTACT=${PJSIP_AOR(${CHANNEL(endpoint)},contact)})
  same => n,Set(CDR(realsrc)=${CALLERID(num)})
  same => n,Set(__REALSRC=${CALLERID(num)})
  same => n,Set(__REALDST=${EXTEN})
  same => n,Set(CDR(edest)=+77172000${EXTEN:-3})
  same => n,Set(CDR(realdst)=${EXTEN})
  same => n,Set(__TRANSFER_CONTEXT=from-internal)
  same => n,Gosub(record-file,s,1(${EXTEN}))
  same => n,Dial(PJSIP/${EXTEN},90,TK)
exten => _91XX,1,Verbose(2, We resive new call from Operator ${CALLERID(num)})
  same => n,Set(CONTACT=${PJSIP_AOR(${CHANNEL(endpoint)},contact)})
  same => n,Set(CDR(realsrc)=${CALLERID(num)})
  same => n,Set(__REALSRC=${CALLERID(num)})
  same => n,Set(__REALDST=${EXTEN})
  same => n,Set(CDR(edest)=+77172000${EXTEN:-3})
  same => n,Set(CDR(realdst)=${EXTEN:-3})
  same => n,Gosub(record-file,s,1(${EXTEN}))
  same => n,Set(__TRANSFER_CONTEXT=from-internal)
  same => n,Set(__identifier=${UNIQUEID})
  same => n,Set(CHANNEL(hangup_handler_push)=end-out-call,s,1(${identifier}))
  same => n,GoSub(start-out-call,s,1(${identifier},+7${mytrunk},${REALDST:1},${REALSRC}))
  same => n,Set(CDR(did)=+7${mytrunk})
  same => n,Dial(PJSIP/${EXTEN:1}@${mytrunk},90,TKU(answer-out-call^${identifier}))
exten => _91XXX,1,Verbose(2, We resive new call from Operator ${CALLERID(num)})
  same => n,Set(CONTACT=${PJSIP_AOR(${CHANNEL(endpoint)},contact)})
  same => n,Set(CDR(realsrc)=${CALLERID(num)})
  same => n,Set(__REALSRC=${CALLERID(num)})
  same => n,Set(__REALDST=${EXTEN})
  same => n,Set(CDR(edest)=+7717200${EXTEN:-4})
  same => n,Set(CDR(realdst)=${EXTEN:-4})
  same => n,Gosub(record-file,s,1(${EXTEN}))
  same => n,Set(__TRANSFER_CONTEXT=from-internal)
  same => n,Set(__identifier=${UNIQUEID})
  same => n,Set(CHANNEL(hangup_handler_push)=end-out-call,s,1(${identifier}))
  same => n,GoSub(start-out-call,s,1(${identifier},+7${mytrunk},+7${REALDST:-10},${REALSRC}))
  same => n,Set(CDR(did)=+7${mytrunk})
  same => n,Dial(PJSIP/${EXTEN:1}@${mytrunk},90,TKU(answer-out-call^${identifier}))
exten => _XXXXXX,1,Verbose(2, We resive new call from Operator ${CALLERID(num)})       
  same => n,Set(CONTACT=${PJSIP_AOR(${CHANNEL(endpoint)},contact)})                          
  same => n,Set(CDR(realsrc)=${CALLERID(num)})                                               
  same => n,Set(__REALSRC=${CALLERID(num)})                                                  
  same => n,Set(__REALDST=${EXTEN})                                                          
  same => n,Set(CDR(edest)=+77172${EXTEN:-6})
  same => n,Set(CDR(realdst)=${EXTEN})                                                       
  same => n,Gosub(record-file,s,1(${EXTEN}))                                                 
  same => n,Set(__TRANSFER_CONTEXT=from-internal)                                            
  same => n,Set(__identifier=${UNIQUEID})                                                    
  same => n,Set(CHANNEL(hangup_handler_push)=end-out-call,s,1(${identifier}))                
  same => n,GoSub(start-out-call,s,1(${identifier},+7${mytrunk},+7${REALDST:-10},${REALSRC}))
  same => n,Set(CDR(did)=+7${mytrunk})                                                                                     
  same => n,Dial(PJSIP/${EXTEN}@${mytrunk},90,TKU(answer-out-call^${identifier}))
exten => _+77XXXXXXXXX,1,Verbose(2, We resive new call from Operator ${CALLERID(num)})
  same => n,Set(CONTACT=${PJSIP_AOR(${CHANNEL(endpoint)},contact)})
  same => n,Set(CDR(realsrc)=${CALLERID(num)})
  same => n,Set(__REALSRC=${CALLERID(num)})
  same => n,Set(__REALDST=${EXTEN})
  same => n,Set(CDR(edest)=${EXTEN})
  same => n,Set(CDR(realdst)=${EXTEN})
  same => n,Gosub(record-file,s,1(${EXTEN}))
  same => n,Set(__TRANSFER_CONTEXT=from-internal)
  same => n,Set(__identifier=${UNIQUEID})
  same => n,Set(CHANNEL(hangup_handler_push)=end-out-call,s,1(${identifier}))
  same => n,GoSub(start-out-call,s,1(${identifier},+7${mytrunk},+7${REALDST:-10},${REALSRC}))
  same => n,Set(CDR(did)=+7${mytrunk})
  same => n,Dial(PJSIP/${EXTEN}@${mytrunk},90,TKU(answer-out-call^${identifier}))
exten => _77XXXXXXXXX,1,Verbose(2, We resive new call from Operator ${CALLERID(num)})
  same => n,Set(CONTACT=${PJSIP_AOR(${CHANNEL(endpoint)},contact)})
  same => n,Set(CDR(realsrc)=${CALLERID(num)})
  same => n,Set(__REALSRC=${CALLERID(num)})
  same => n,Set(__REALDST=${EXTEN})
  same => n,Set(CDR(edest)=+7${EXTEN:-11})
  same => n,Set(CDR(realdst)=${EXTEN})
  same => n,Gosub(record-file,s,1(${EXTEN}))
  same => n,Set(__TRANSFER_CONTEXT=from-internal)
  same => n,Set(__identifier=${UNIQUEID})
  same => n,Set(CHANNEL(hangup_handler_push)=end-out-call,s,1(${identifier}))
  same => n,GoSub(start-out-call,s,1(${identifier},+7${mytrunk},+7${REALDST:-10},${REALSRC}))
  same => n,Set(CDR(did)=+7${mytrunk})
  same => n,Dial(PJSIP/+${EXTEN}@${mytrunk},90,TKU(answer-out-call^${identifier}))
exten => _87XXXXXXXXX,1,Verbose(2, We resive new call from Operator ${CALLERID(num)})
  same => n,Set(CONTACT=${PJSIP_AOR(${CHANNEL(endpoint)},contact)})
  same => n,Set(CDR(realsrc)=${CALLERID(num)})
  same => n,Set(__REALSRC=${CALLERID(num)})
  same => n,Set(__REALDST=${EXTEN})
  same => n,Set(CDR(edest)=+7${EXTEN:-10})
  same => n,Set(CDR(realdst)=${EXTEN})
  same => n,Gosub(record-file,s,1(${EXTEN}))
  same => n,Set(__TRANSFER_CONTEXT=from-internal)
  same => n,Set(__identifier=${UNIQUEID})
  same => n,Set(CHANNEL(hangup_handler_push)=end-out-call,s,1(${identifier}))
  same => n,GoSub(start-out-call,s,1(${identifier},+7${mytrunk},+7${REALDST:-10},${REALSRC}))
  same => n,Set(CDR(did)=+7${mytrunk})
  same => n,Dial(PJSIP/+7${EXTEN:1}@${mytrunk},90,TKU(answer-out-call^${identifier}))
exten => h,1,Noop(END CALLS - ${ANSWEREDTIME} seconds )
  same => n,Noop("extended CDR")
  same => n,Set(CDR(billseccustom)=${CDR(billsec)})
  same => n,Set(CDR(hangupcause)=16)
  same => n,Set(CDR(peerip)=${PJSIP_CONTACT(${CONTACT},via_addr)})
  same => n,Set(CDR(recvip)=${PJSIP_CONTACT(${CONTACT},uri)})
  same => n,Set(CDR(fromuri)=${CHANNEL(pjsip,remote_addr)})
  same => n,Set(CDR(remoteip)=${PJSIP_CONTACT(${CONTACT},uri)})
  same => n,Set(CDR(uri)=${CHANNEL(pjsip,request_uri)})
  same => n,Set(USER_AGENT=${PJSIP_CONTACT(${CONTACT},user_agent)})
  same => n,Set(CDR(useragent)=${USER_AGENT})
  same => n,Set(CDR(codec1)=${CHANNEL(audioreadformat)})
  same => n,Set(CDR(codec2)=${CHANNEL(audiowriteformat)})
  same => n,Set(CDR(llp)=${CHANNEL(rtcp,local_normdevrxploss)})
  same => n,Set(CDR(rlp)=${CHANNEL(rtcp,remote_normdevrxploss)})
  same => n,Set(CDR(ljitt)=${CHANNEL(rtcp,local_normdevjitter)})
  same => n,Set(CDR(rjitt)=${CHANNEL(rtcp,remote_normdevjitter)})
  same => n,Set(CDR(durationcustom)=${CDR(duration)})
  same => n,Return()


[record-file]
exten => s,1,Set(YYYY=${STRFTIME(${EPOCH},,%Y)})
  same => n,Set(MM=${STRFTIME(${EPOCH},,%m)})
  same => n,Set(DD=${STRFTIME(${EPOCH},,%d)})
  same => n,Set(HMS=${STRFTIME(${EPOCH},,%H%M%S)})
  same => n,Set(FILENAME=${HMS}-${CALLERID(num)}-${ARG1}-${UNIQUEID})
  same => n,Set(CDR(filename)=${monitordir}/${YYYY}/${MM}/${DD}/${FILENAME}.mp3)
  same => n,Set(MIXMON_ARGS=mkdir -p ${monitordir}/${YYYY}/${MM}/${DD} && nice -n 19 /usr/bin/lame --silent --resample 11.025 -b 16 -t -mm ${monitordir}/${FILENAME}.wav ${monitordir}/${YYYY}/${MM}/${DD}/${FILENAME}.mp3 && rm -f ${monitordir}/${FILENAME}.wav)
  same => n,MixMonitor(${FILENAME}.wav,,${MIXMON_ARGS})
  same => n,Return()
exten => h,1,Noop(END CALLS - ${ANSWEREDTIME} seconds )
  same => n,Set(CDR(billseccustom)=${CDR(billsec)})
  same => n,Set(CDR(hangupcause)=${HANGUPCAUSE})
  same => n,Set(CDR(peerip)=${PJSIP_CONTACT(${CONTACT},via_addr)})
  same => n,Set(CDR(recvip)=${PJSIP_CONTACT(${CONTACT},uri)})
  same => n,Set(CDR(fromuri)=${CHANNEL(pjsip,remote_addr)})
  same => n,Set(CDR(remoteip)=${PJSIP_CONTACT(${CONTACT},uri)})
  same => n,Set(CDR(uri)=${CHANNEL(pjsip,request_uri)})
  same => n,Set(USER_AGENT=${PJSIP_CONTACT(${CONTACT},user_agent)})
  same => n,Set(CDR(useragent)=${USER_AGENT})
  same => n,Set(CDR(codec1)=${CHANNEL(audioreadformat)})
  same => n,Set(CDR(codec2)=${CHANNEL(audiowriteformat)})
  same => n,Set(CDR(llp)=${CHANNEL(rtcp,local_normdevrxploss)})
  same => n,Set(CDR(rlp)=${CHANNEL(rtcp,remote_normdevrxploss)})
  same => n,Set(CDR(ljitt)=${CHANNEL(rtcp,local_normdevjitter)})
  same => n,Set(CDR(rjitt)=${CHANNEL(rtcp,remote_normdevjitter)})
  same => n,Set(CDR(durationcustom)=${CDR(duration)})
  same => n,Return()


[from-queue]
exten => _10[1235678],1,Verbose(2, We resive new call from Operator ${CALLERID(num)})
  same => n,Set(CDR(realsrc)=${CALLERID(num)})
  same => n,Set(__REALSRC=${CALLERID(num)})
  same => n,Set(__REALDST=${EXTEN})
  same => n,Set(CDR(realdst)=${EXTEN})
  same => n,Set(__TRANSFER_CONTEXT=from-internal)
  same => n,Gosub(record-file,s,1(${EXTEN}))
  same => n,Set(CHANNEL(hangup_handler_push)=endcall-to-operator,s,1(${identifier},${EXTEN}))
  same => n,Gosub(call-to-operator,s,1(${identifier},${EXTEN}))
  same => n,Set(CDR(edest)=${EXTEN})
  same => n,Dial(PJSIP/${EXTEN},90,tkU(answer-operator^${identifier}^${EXTEN}))
exten => h,1,Noop(END CALLS - ${ANSWEREDTIME} seconds )
  same => n,Noop("extended CDR")
  same => n,Set(CDR(billseccustom)=${CDR(billsec)})
  same => n,Set(CDR(hangupcause)=16)
  same => n,Set(CDR(peerip)=${PJSIP_CONTACT(${CONTACT},via_addr)})
  same => n,Set(CDR(recvip)=${PJSIP_CONTACT(${CONTACT},uri)})
  same => n,Set(CDR(fromuri)=${CHANNEL(pjsip,remote_addr)})
  same => n,Set(CDR(remoteip)=${PJSIP_CONTACT(${CONTACT},uri)})
  same => n,Set(CDR(uri)=${CHANNEL(pjsip,request_uri)})
  same => n,Set(USER_AGENT=${PJSIP_CONTACT(${CONTACT},user_agent)})
  same => n,Set(CDR(useragent)=${USER_AGENT})
  same => n,Set(CDR(codec1)=${CHANNEL(audioreadformat)})
  same => n,Set(CDR(codec2)=${CHANNEL(audiowriteformat)})
  same => n,Set(CDR(llp)=${CHANNEL(rtcp,local_normdevrxploss)})
  same => n,Set(CDR(rlp)=${CHANNEL(rtcp,remote_normdevrxploss)})
  same => n,Set(CDR(ljitt)=${CHANNEL(rtcp,local_normdevjitter)})
  same => n,Set(CDR(rjitt)=${CHANNEL(rtcp,remote_normdevjitter)})
  same => n,Set(CDR(durationcustom)=${CDR(duration)})
  same => n,Return()


[parking_timeout]
exten => s,1,NoOp(Parked call channel that timed out: ${CHANNEL(name)})
  same => n,Playback(vm-goodbye)
  same => n,Hangup()

